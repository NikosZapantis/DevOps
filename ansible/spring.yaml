---
- hosts: all

  vars:
    appdir: "/home/azureuser/backend/crowdfunding"
    app:
      env:
        SPRING_DATASOURCE_URL: "jdbc:postgresql://dpg-d0oa61juibrs73a8nne0-a.oregon-postgres.render.com:5432/devopsdb_n794"
        SPRING_DATASOURCE_USERNAME: devopsuser
        SPRING_DATASOURCE_PASSWORD: RGomWH4BLdSb6rwGPrsiuPwaNJkEFELZ

  pre_tasks:
    - name: Install java
      apt:
        name: openjdk-21-jdk
        state: present
        update_cache: yes
      become: true

  tasks:
    - name: Archive Spring Project locally
      delegate_to: localhost
      run_once: true
      command: >
        tar --exclude='target' --exclude='.git' -czf /tmp/backend.tar.gz -C ../App/backend/ .

    - name: Copy backend archive to VM
      copy:
        src: /tmp/backend.tar.gz
        dest: /tmp/backend.tar.gz

    - name: Extract backend archive
      unarchive:
        src: /tmp/backend.tar.gz
        dest: "/home/azureuser/backend/"
        remote_src: yes
        owner: azureuser
        group: azureuser
      become: true      

    - name: Delete remote archive
      file:
        path: /tmp/backend.tar.gz
        state: absent

    - name: Set execute permission for mvnw
      file:
        path: "{{ appdir }}/mvnw"
        mode: '0755'

    - name: Populate application.properties
      lineinfile:
        #might need to be dest: "{{ appdir }}/backend/src/main/resources/application.properties"
        dest: "{{ appdir }}/src/main/resources/application.properties"
        state: present
        regexp: "^{{ item.key }}="
        line: "{{ item.key }}={{ item.value }}"
      with_items:
        - "{{ app.env | dict2items }}"

    - name: Build the Spring project
      block:

      - name: Build the Spring application
        command: "./mvnw clean package -Dmaven.test.skip"
        args:
          chdir: "{{ appdir }}"
    
      rescue:

        - name: Fetch the SHA-512 checksum for Maven 3.9.9
          get_url:
            url: https://downloads.apache.org/maven/maven-3/3.9.9/binaries/apache-maven-3.9.9-bin.zip.sha512
            dest: /tmp/maven_sha512.txt
            validate_certs: yes
            force: yes

        - name: Read the SHA-512 checksum from the file
          command: cat /tmp/maven_sha512.txt
          register: sha512_checksum

        - name: Replace the distributionSha512Sum line in maven-wrapper.properties
          replace:
            path: "{{ appdir }}/.mvn/wrapper/maven-wrapper.properties"
            regexp: '^distributionSha'
            replace: "distributionSha512Sum={{ sha512_checksum.stdout }}"
        
        - name: Clean up the temporary file
          file:
            path: /tmp/maven_sha512.txt
            state: absent
          when: sha512_checksum is defined
        
      always:
        - name: "Build the Spring application"
          command: "./mvnw package -Dmaven.test.skip "
          args:
              chdir: "{{ appdir }}"

    - name: copy spring service file
      template:
        src: files/spring.service.j2
        dest: "/etc/systemd/system/spring.service"
      become: true
      become_user: root
      notify: restart spring

    - name: reload spring service
      service:
        name: spring
        state: restarted
      become: true

    - name: ensure spring service started
      service:
        name: spring
        state: started
        enabled: yes
      become: true

    - name: "APT - install nginx"
      apt:
        name: nginx
        update_cache: yes
      become: true

    - name: copy nginx conf file [backend]
      template:
        src: roles/reverseproxy/nginx.js.j2
        dest: "/etc/nginx/sites-available/spring"
      become: true

    - name: enable spring site in nginx
      file:
        src: "/etc/nginx/sites-available/spring"
        dest: "/etc/nginx/sites-enabled/spring"
        state: link
      become: true
      notify: restart nginx

    - name: de-activate default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      become: true
      notify: restart nginx

  handlers:
  - name: restart spring
    service:
      name: spring
      state: restarted
    become: true

  - name: restart nginx
    service:
      name: nginx
      state: restarted
    become: true

      